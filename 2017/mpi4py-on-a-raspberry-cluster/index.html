<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />


<title>Cluster Computing with some Raspberry Pis | Simon Neutert</title>

<meta name="description" content="I am a Ruby (on Rails) developer and open source enthusiast. Super interest in Clojure. Based in Ingelheim, next to Mainz and Wiesbaden (Rhein-Main)." />

<link rel="stylesheet" href="/_bridgetown/static/index.POPT2NFP.css" data-turbo-track="reload" />

<script src="/_bridgetown/static/index.Q4PHQU7R.js" data-turbo-track="reload" defer></script>


    <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Simon Neutert" />
  </head>
  <body class="post ">
    <header>
  <!-- 
  <img src="/images/logo.svg" alt="Logo" />
  -->
</header>

<nav>
  <ul>
    <li><a href="/">Home</a></li>
    <!-- <li><a href="/telegram">On Telegram</a></li> -->
    <!-- <li><a href="/about">About</a></li> -->
    <li><a href="/posts">Blog</a></li>
  </ul>
</nav>


    <main>
      <a href="/posts" style="text-decoration:none; text-align=center;">↖️ Show all posts</a>

<hr />

<h1>Cluster Computing with some Raspberry Pis</h1>

<p><strong>Please, skim the whole article first, at least read the headers. Work your way through, step by step, reading the next chapter once before you continue :)</strong></p>

<p><strong>What you need:</strong></p>

<ul>
  <li>
    <p>two or more Raspberry Pis + SD Cards + Power + Ethernet Cables</p>
  </li>
  <li>
    <p>a Router and/or a Switch</p>
  </li>
</ul>

<h2 id="preparing-a-master-image">Preparing a Master Image</h2>

<p>Current Raspbian (2017-11) ships with Python 3.5. All we need to do now, is set up an <a href="https://de.wikipedia.org/wiki/Message_Passing_Interface">MPI</a>. <a href="https://www.raspberrypi.org/downloads/raspbian/">Download Raspbian</a></p>

<p>Set some time aside for the following - if concurrency isn&#8217;t your thing and you need to sit in front of your screen ;-) (a quality, class 10 SD card can plough through the setup process)</p>

<ul>
  <li>
    <p><strong>Setup a fresh SD with Raspbian Lite.</strong></p>

    <p>when finished, enable SSH by navigate to the SD and add a plain file called <code class="highlighter-rouge">ssh</code>.</p>
  </li>
  <li>
    <p>boot and ssh into your Raspberry Pi</p>

    <ul>
      <li>
        <p><code class="highlighter-rouge">$ sudo apt update &amp;&amp; sudo apt upgrade</code></p>
      </li>
      <li>
        <p><code class="highlighter-rouge">$ sudo raspi-config</code> set localization and stuff if you want</p>
      </li>
      <li>
        <p>optional/fyi: limiting the dumped image size when using dd can be done by passing the <strong>count</strong> argument.</p>

        <p><code class="highlighter-rouge">dd</code>: limit image size with <code class="highlighter-rouge">count=3700</code>__.</p>

        <p>In my case dumping looks like: (<a href="https://www.raspberrypi.org/documentation/linux/filesystem/backup.md">how to backup your Raspberry Pi</a>):</p>

        <p><code class="highlighter-rouge">sudo dd bs=1m if=/dev/rdiskX of=RaspbianLitePresetImageDE_8GB_PiMaster.img count=3700</code></p>
      </li>
      <li>
        <p><strong>Install mpich and python3-dev</strong></p>

        <ul>
          <li>
            <p><code class="highlighter-rouge">$ sudo apt update &amp;&amp; sudo apt upgrade &amp;&amp; sudo reboot now</code></p>
          </li>
          <li>
            <p><code class="highlighter-rouge">$ sudo apt-get install libssl-dev libcr-dev python3-dev python3-pip mpich libatlas-base-dev libatlas-dev libatlas3-base cython &amp;&amp; sudo apt update --fix-missing &amp;&amp; sudo reboot now</code></p>
          </li>
        </ul>
      </li>
      <li>
        <p><strong>Download the mpi4py package and unpack.</strong></p>

        <ul>
          <li>
            <p><code class="highlighter-rouge">$ wget https://bitbucket.org/mpi4py/mpi4py/downloads/mpi4py-3.0.0.tar.gz</code></p>
          </li>
          <li>
            <p>if the download link is broken google (<a href="http://lmgtfy.com/?q=mpi4py+source">this: mpi4py source</a>)</p>
          </li>
          <li>
            <p><code class="highlighter-rouge">$ tar zxf mpi4py-3.0.0.tar.gz</code></p>
          </li>
          <li>
            <p><code class="highlighter-rouge">$ cd mpi4py-3.0.0/</code></p>
          </li>
          <li>
            <p><code class="highlighter-rouge">$ sudo python3 setup.py build --mpicc=/usr/bin/mpicc</code></p>
          </li>
          <li>
            <p><code class="highlighter-rouge">$ sudo python3 setup.py install</code></p>
          </li>
        </ul>
      </li>
      <li>
        <p><strong>Add Pandas. It&#8217;s more fun with Pandas. Pandas brings Numpy.</strong></p>

        <ul>
          <li><code class="highlighter-rouge">$ python3 -m pip install --user pandas &amp;&amp; sudo reboot now</code></li>
        </ul>
      </li>
      <li>
        <p>set a new password, so your cluster will be protected and has the same one over all:</p>

        <p><code class="highlighter-rouge">$ passwd</code></p>
      </li>
    </ul>
  </li>
</ul>

<h2 id="cloning">Cloning</h2>

<ul>
  <li>
    <p>shutdown and clone the SD Card to your workstation (<a href="https://www.raspberrypi.org/documentation/linux/filesystem/backup.md">help</a>)</p>
  </li>
  <li>
    <p>load the image to a second SD card, then cable up and boot both Raspberry Pis</p>
  </li>
</ul>

<h2 id="master">Master</h2>

<p><strong>ssh into one of the Pi - this will be your master node from now on.</strong></p>

<ul>
  <li>
    <p>change hostname from raspberrypi to pimaster: <code class="highlighter-rouge">$ sudo nano /etc/hostname</code></p>
  </li>
  <li>
    <p>reboot, reconnect (with new hostname)</p>
  </li>
  <li>
    <p>create an ssh key without password (default path, no password)</p>

    <p><code class="highlighter-rouge">$ ssh-keygen -t rsa -b 4096</code></p>
  </li>
  <li>
    <p>copy your public key <code class="highlighter-rouge">$ cat ~/.ssh/id_rsa.pub</code> and save it temporarily in a word file on your workstation</p>
  </li>
  <li>
    <p>optional: shutdown and backup SD card (you might need to replace your master when something breaks)</p>
  </li>
</ul>

<h2 id="slavenode">Slave/Node</h2>

<p><strong>ssh into your slave machine</strong></p>

<ul>
  <li>
    <p><code class="highlighter-rouge">$ mkdir .ssh</code></p>
  </li>
  <li>
    <p>paste your master&#8217;s public keys into <code class="highlighter-rouge">/home/pi/.ssh/authorized_keys</code>:</p>

    <p><code class="highlighter-rouge">$ nano .ssh/autorized_keys</code></p>
  </li>
  <li>
    <p>change hostname to pinode00</p>

    <p><code class="highlighter-rouge">$ sudo nano /etc/hostname</code></p>
  </li>
  <li>
    <p>shutdown and backup SD card, as this is the &#8220;master clone&#8221; for all nodes/slaves to come</p>
  </li>
  <li>
    <p>put the SD back in the Slave Raspberry and boot up</p>
  </li>
  <li>
    <p>change hostname to pinode01</p>

    <p><code class="highlighter-rouge">$ sudo nano /etc/hostname</code></p>
  </li>
</ul>

<h2 id="connect-master-and-slave">Connect Master and Slave</h2>

<p>ssh to master then run <code class="highlighter-rouge">$ ssh pi@pinode01</code> making the machines known to each other</p>

<h2 id="adding-nodes">Adding Nodes</h2>

<p>You can add further slaves, using the node image you created earlier. Be sure to add the nodes one by one.</p>

<ul>
  <li>
    <p>ssh into master, and from there ssh to pi@pinode00</p>
  </li>
  <li>
    <p>rename your new slave&#8217;s hostname from pinode00 to the next number that makes sense :-)</p>

    <p><code class="highlighter-rouge">$ sudo nano /etc/hostname</code></p>
  </li>
  <li>
    <p>reboot slave</p>
  </li>
</ul>

<h2 id="run-your-cluster">Run Your Cluster</h2>

<p>to utilize all members of the cluster, ssh to your master and add a hostfile to the directory your script is in, looking like this for one master and one slave:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># content of hostfile</span>
pimaster
pinode01

<span class="c"># add all cluster member with their hostname</span>
</code></pre></div></div>

<h2 id="demo--test">Demo / Test</h2>

<ul>
  <li>
    <p>navigate to <code class="highlighter-rouge">/home/pi/mpi4py-3.0.0/demo</code> on your master</p>
  </li>
  <li>
    <p>create your hostfile (as above)</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">$ mpiexec --hostfile hostfile python3 helloworld.py</code></p>
  </li>
</ul>

<p><strong>all your nodes should say hello :D</strong></p>

<h2 id="errors--help--network">Errors / Help / Network</h2>

<p>If mpiexec throws proxy or connection errors, you might need to check your router for duplicate hostnames in its network settings. This caused major hickups in my run network (AVM Fritz Box 7490).</p>


<hr />

<a id="btn-previous" href="/2018/python3-functional-factorial/" style="text-decoration:none;">⬅️ Read previous</a>

<a id="btn-next" href="/2017/python3-on-raspberry-pi/" style="float: right; text-decoration:none;">Read next ➡️</a>

    </main>

    <footer>
  <p style="text-align:center"><strong>
    <a href="/feed.xml">Feed</a>
  </strong></p>

  <hr />

  <h6>Imprint</h6>
  <p>
    <strong>Simon Neutert</strong><br />
    <span id="imprint-address">
      Postfach 1120, 55258 Ingelheim
    </span>
  </p>
  <p style="text-align:center"><strong>
    Generated using <a href="https://www.bridgetownrb.com">Bridgetown</a>
  </strong></p>
</footer>

  </body>
</html>

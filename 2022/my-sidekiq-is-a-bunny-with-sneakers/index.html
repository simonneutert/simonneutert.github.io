<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />


<title>My Sidekiq may be a bunny with sneakers | Simon Neutert</title>

<meta name="description" content="I am a Ruby (on Rails) developer and open source enthusiast. Super interest in Clojure. Based in Ingelheim, next to Mainz and Wiesbaden (Rhein-Main)." />

<link rel="stylesheet" href="/_bridgetown/static/index.POPT2NFP.css" data-turbo-track="reload" />

<script src="/_bridgetown/static/index.KGKIVIBR.js" data-turbo-track="reload" defer></script>


    <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Simon Neutert" />
  </head>
  <body class="post ">
    <header>
  <!-- 
  <img src="/images/logo.svg" alt="Logo" />
  -->
</header>

<nav>
  <ul>
    <li><a href="/">Home</a></li>
    <!-- <li><a href="/telegram">On Telegram</a></li> -->
    <!-- <li><a href="/about">About</a></li> -->
    <li><a href="/posts">Blog</a></li>
  </ul>
</nav>


    <main>
      <a href="/posts" style="text-decoration:none; text-align=center;">↖️ Show all posts</a>

<hr />

<h1>My Sidekiq may be a bunny with sneakers</h1>

<p>I overheard a conversation at the station:<br />
“<a href="https://rubyonrails.org">Rails</a>, Redis and <a href="https://sidekiq.org">Sidekiq</a> - every kid knows: they mean business! 😎”<br />
“Yeah, but I’ll go with the <em>Magic <a href="http://rubybunny.info">Bunny</a> with <a href="https://github.com/jondot/sneakers">Sneakers</a></em>, cheers!”</p>

<hr />

<p>🚨 sneakers was forked and the project is now maintained under the name <a href="https://github.com/ruby-amqp/kicks">kicks</a>!</p>

<hr />

<p>Just kidding 😅 What got me thinking and in an experimental mood was <a href="https://stanko.io/rabbitmq-is-more-than-a-sidekiq-replacement-b730d8176fb">Stanko.io - RabbitMQ is more than a Sidekiq Replacement</a>. And I highly encourage you to at least look at the nice gifs the author made to clear things up.</p>

<p>Let’s build on this quote:</p>

<blockquote>
  <p>The biggest difference between the two implementations is the ack! on line 10. That line enables Sneakers and RabbitMQ to guarantee that a job has been processed. This is a feature of RabbitMQ’s communication protocol — AMQP. In AMQP a message can be popped from a queue in two modes — ack mode and no-ack mode.</p>

  <p>In ack mode the consumer must specify the maximum amount of time for it to process the message. When the consumer pops a message from the queue it’s virtually removed from it, but RabbitMQ still keeps a copy of it. If the consumer fails to send an “ack” signal in the specified time period the message is put back at the front of the queue so that another consumer can process it. If the consumer sends an “ack” signal in the specified time period the message is fully removed from RabbitMQ. In no-ack mode no guarantees are given, no time window has to be specified, and no “ack” signal has to be sent.</p>
</blockquote>

<h3 id="ack---work-done-job-done-free-the-queue">ACK! - Work done! Job done! FREE THE QUEUE!</h3>

<p>Let’ have a nice and clean job queue over two terminals 💻⚡️💻</p>

<h4 id="prerequisities">Prerequisities</h4>

<ul>
  <li>You need Docker</li>
  <li>run RabbitMQ in Docker:<br />
<code class="highlighter-rouge">$ docker run -d --hostname my-rabbit --name some-rabbit -p15672:15672 -p5672:5672 rabbitmq:3-management</code></li>
  <li>open your browser at <code class="highlighter-rouge">localhost:15672</code> and login with <code class="highlighter-rouge">guest:guest</code></li>
  <li><code class="highlighter-rouge">$ gem install sneakers bunny pry</code></li>
</ul>

<p>We will now put two simple ruby scripts to use.</p>

<p><strong>‼️ If you get weird errors from RabbitMQ, try deleting all queues first</strong></p>

<p>First the consumer:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># easy_consumer.rb</span>
<span class="nb">require</span> <span class="s1">'pry'</span>
<span class="nb">require</span> <span class="s1">'bunny'</span>
<span class="nb">require</span> <span class="s1">'prettyprint'</span>

<span class="k">begin</span>
  <span class="c1"># Start a communication session with RabbitMQ</span>
  <span class="n">conn</span> <span class="o">=</span> <span class="no">Bunny</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">conn</span><span class="p">.</span><span class="nf">start</span>

  <span class="c1"># open a channel</span>
  <span class="n">ch</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">create_channel</span>
  <span class="n">ch</span><span class="p">.</span><span class="nf">confirm_select</span>

  <span class="c1"># declare a queue</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">ch</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s1">'test1'</span><span class="p">)</span>
  <span class="n">q</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="ss">manual_ack: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">delivery_info</span><span class="p">,</span> <span class="n">_metadata</span><span class="p">,</span> <span class="n">payload</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"This is the message: </span><span class="si">#{</span><span class="n">payload</span><span class="si">}</span><span class="s2">"</span>

    <span class="c1"># acknowledge the delivery so that RabbitMQ can mark it for deletion</span>
    <span class="n">ch</span><span class="p">.</span><span class="nf">ack</span><span class="p">(</span><span class="n">delivery_info</span><span class="p">.</span><span class="nf">delivery_tag</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">while</span> <span class="kp">true</span>
    <span class="c1"># yo</span>
  <span class="k">end</span>

  <span class="c1"># binding.pry</span>
<span class="k">rescue</span> <span class="no">SignalException</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="n">pp</span> <span class="s1">'Closing ...'</span>
  <span class="n">ch</span><span class="p">.</span><span class="nf">close</span>
  <span class="c1"># close the connection</span>
  <span class="n">conn</span><span class="p">.</span><span class="nf">close</span>
<span class="k">end</span>
</code></pre></div></div>

<p>run <code class="highlighter-rouge">$ ruby easy_consumer.rb</code></p>

<p>The producer is just as simple:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># easy_producer.rb</span>
<span class="nb">require</span> <span class="s1">'pry'</span>
<span class="nb">require</span> <span class="s1">'bunny'</span>
<span class="nb">require</span> <span class="s1">'json'</span>
<span class="nb">require</span> <span class="s1">'prettyprint'</span>

<span class="k">begin</span>
  <span class="c1"># Start a communication session with RabbitMQ</span>
  <span class="n">conn</span> <span class="o">=</span> <span class="no">Bunny</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">conn</span><span class="p">.</span><span class="nf">start</span>

  <span class="c1"># open a channel</span>
  <span class="n">ch</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">create_channel</span>
  <span class="n">ch</span><span class="p">.</span><span class="nf">confirm_select</span>

  <span class="c1"># declare a queue</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">ch</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s1">'test1'</span><span class="p">)</span>

  <span class="c1"># publish a message to the default exchange which then gets routed to this queue</span>
  <span class="n">q</span><span class="p">.</span><span class="nf">publish</span><span class="p">({</span> <span class="ss">type: </span><span class="s1">'error'</span><span class="p">,</span> <span class="ss">message: </span><span class="s1">'HALP!'</span><span class="p">,</span> <span class="ss">error: </span><span class="s1">'CODE001'</span> <span class="p">}.</span><span class="nf">to_json</span><span class="p">)</span>

  <span class="c1"># publish to your heart's content</span>
  <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
<span class="k">ensure</span>
  <span class="nb">puts</span> <span class="s1">'Closing ...'</span>
  <span class="n">ch</span><span class="p">.</span><span class="nf">close</span>
  <span class="c1"># close the connection</span>
  <span class="n">conn</span><span class="p">.</span><span class="nf">close</span>
<span class="k">end</span>

</code></pre></div></div>

<p>Now in a second terminal run: <code class="highlighter-rouge">$ ruby easy_producer</code></p>

<p>and use pry to send messages - good times 👏</p>

<h2 id="whats-with-the-sneakers">What’s with the sneakers?</h2>

<p>Time to put the worker to work 🤓</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># bunny_sneaker_worker.rb</span>
<span class="nb">require</span> <span class="s1">'pry'</span>
<span class="nb">require</span> <span class="s1">'bunny'</span>
<span class="nb">require</span> <span class="s1">'sneakers'</span>
<span class="nb">require</span> <span class="s1">'prettyprint'</span>
<span class="nb">require</span> <span class="s1">'json'</span>

<span class="k">class</span> <span class="nc">Processor</span>
  <span class="kp">include</span> <span class="no">Sneakers</span><span class="o">::</span><span class="no">Worker</span>
  <span class="n">from_queue</span> <span class="ss">:testsneaker</span>

  <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">pp</span> <span class="s1">'OUTPUT:'</span>
    <span class="n">pp</span> <span class="n">err</span>
    <span class="n">ack!</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>run it according to the <em>sneakers docs</em><br />
<code class="highlighter-rouge">$ sneakers work Processor --require bunny_sneaker_worker.rb</code></p>

<p>THEN fire up a producer!</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># bunny_sneaker_producer.rb</span>
<span class="nb">require</span> <span class="s1">'pry'</span>
<span class="nb">require</span> <span class="s1">'bunny'</span>
<span class="nb">require</span> <span class="s1">'json'</span>

<span class="k">def</span> <span class="nf">quick_publish</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s1">'HALP!'</span><span class="p">)</span>
  <span class="n">json_message</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">type: </span><span class="s1">'error'</span><span class="p">,</span>
                   <span class="ss">message: </span><span class="n">message</span><span class="p">,</span>
                   <span class="ss">error: </span><span class="s1">'CODE001'</span> <span class="p">}.</span><span class="nf">to_json</span>

  <span class="n">ch</span><span class="p">.</span><span class="nf">default_exchange</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">json_message</span><span class="p">,</span> <span class="ss">routing_key: </span><span class="s1">'testsneaker'</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">begin</span>
  <span class="c1"># Start a communication session with RabbitMQ</span>
  <span class="n">conn</span> <span class="o">=</span> <span class="no">Bunny</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">conn</span><span class="p">.</span><span class="nf">start</span>

  <span class="n">ch</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">create_channel</span>
  <span class="n">ch</span><span class="p">.</span><span class="nf">default_exchange</span><span class="p">.</span><span class="nf">publish</span><span class="p">({</span> <span class="ss">type: </span><span class="s1">'error'</span><span class="p">,</span> <span class="ss">message: </span><span class="s1">'HALP!'</span><span class="p">,</span> <span class="ss">error: </span><span class="s1">'CODE001'</span> <span class="p">}.</span><span class="nf">to_json</span><span class="p">,</span> <span class="ss">routing_key: </span><span class="s1">'testsneaker'</span><span class="p">)</span>

  <span class="c1"># publish to your heart's content</span>
  <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span> <span class="c1"># quick_publish(ch, "What's going on here?")</span>
<span class="k">ensure</span>
  <span class="n">ch</span><span class="p">.</span><span class="nf">close</span>
  <span class="c1"># close the connection</span>
  <span class="n">conn</span><span class="p">.</span><span class="nf">close</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now I need to do a little more digging what RabbitMQ really is and how the Admin UI can help me wrap my head around.</p>

<h2>🚀</h2>


<hr />

<a href="/2022/truffleruby-goes-brrrr/" style="text-decoration:none;">⬅️ Read previous</a>

<a href="/2022/cache-requests-with-roda/" style="float: right; text-decoration:none;">Read next ➡️</a>

    </main>

    <footer>
  <p style="text-align:center"><strong>
    <a href="/feed.xml">Feed</a>
  </strong></p>

  <hr />

  <h6>Imprint</h6>
  <p>
    <strong>Simon Neutert</strong><br />
    <span id="imprint-address">
      Postfach 1120, 55258 Ingelheim
    </span>
  </p>
  <p style="text-align:center"><strong>
    Generated using <a href="https://www.bridgetownrb.com">Bridgetown</a>
  </strong></p>
</footer>

  </body>
</html>

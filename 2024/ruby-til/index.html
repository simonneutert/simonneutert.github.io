<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />


<title>Today I learned in Rubyland | Simon Neutert</title>

<meta name="description" content="I am a Ruby (on Rails) developer and open source enthusiast. Super interest in Clojure. Based in Ingelheim, next to Mainz and Wiesbaden (Rhein-Main)." />

<link rel="stylesheet" href="/_bridgetown/static/index.POPT2NFP.css" data-turbo-track="reload" />

<script src="/_bridgetown/static/index.KGKIVIBR.js" data-turbo-track="reload" defer></script>


    <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Simon Neutert" />
  </head>
  <body class="post ">
    <header>
  <!-- 
  <img src="/images/logo.svg" alt="Logo" />
  -->
</header>

<nav>
  <ul>
    <li><a href="/">Home</a></li>
    <!-- <li><a href="/telegram">On Telegram</a></li> -->
    <!-- <li><a href="/about">About</a></li> -->
    <li><a href="/posts">Blog</a></li>
  </ul>
</nav>


    <main>
      <a href="/posts" style="text-decoration:none; text-align=center;">↖️ Show all posts</a>

<hr />

<h1>Today I learned in Rubyland</h1>

<p>Benchmarking my Ruby code shed light on a few things I didn’t know before about <code class="highlighter-rouge">.nil?</code> and <code class="highlighter-rouge">Set#include?</code>.</p>

<h2 id="boolean-operations-nil-vs-">Boolean operations <code class="highlighter-rouge">nil?</code> vs <code class="highlighter-rouge">==</code></h2>

<p><code class="highlighter-rouge">.nil?</code> makes the code more readable, but it’s slowing things down.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'benchmark'</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="no">Benchmark</span><span class="p">.</span><span class="nf">bm</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s1">'nil?'</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="kp">nil</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">}</span> <span class="p">}</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s1">'=='</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="kp">nil</span> <span class="o">==</span> <span class="kp">nil</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>

<span class="p">[</span><span class="c1">#&lt;Benchmark::Tms:0x000000011ee2b1d8</span>
  <span class="vi">@cstime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@cutime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@label</span><span class="o">=</span><span class="s2">"nil?"</span><span class="p">,</span>
  <span class="vi">@real</span><span class="o">=</span><span class="mf">0.046839999999065185</span><span class="p">,</span>
  <span class="vi">@stime</span><span class="o">=</span><span class="mf">0.0005310000000000037</span><span class="p">,</span>
  <span class="vi">@total</span><span class="o">=</span><span class="mf">0.046846</span><span class="p">,</span>
  <span class="vi">@utime</span><span class="o">=</span><span class="mf">0.046314999999999995</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="c1">#&lt;Benchmark::Tms:0x000000011ee2b098</span>
  <span class="vi">@cstime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@cutime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@label</span><span class="o">=</span><span class="s2">"=="</span><span class="p">,</span>
  <span class="vi">@real</span><span class="o">=</span><span class="mf">0.033373000000210595</span><span class="p">,</span>
  <span class="vi">@stime</span><span class="o">=</span><span class="mf">0.00028000000000000247</span><span class="p">,</span>
  <span class="vi">@total</span><span class="o">=</span><span class="mf">0.033374000000000015</span><span class="p">,</span> <span class="err">👑👑👑</span>
  <span class="vi">@utime</span><span class="o">=</span><span class="mf">0.03309400000000001</span><span class="o">&gt;</span><span class="p">]</span>
</code></pre></div></div>

<p>Take a look at this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'benchmark'</span>

<span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="ss">a: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">b: </span><span class="p">{</span><span class="ss">c: </span><span class="mi">2</span><span class="p">}}</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="no">Benchmark</span><span class="p">.</span><span class="nf">bm</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s1">'nil?'</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="n">h</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:b</span><span class="p">,</span> <span class="ss">:d</span><span class="p">).</span><span class="nf">nil?</span> <span class="p">}</span> <span class="p">}</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s1">'=='</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="n">h</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:b</span><span class="p">,</span> <span class="ss">:d</span><span class="p">)</span> <span class="o">==</span> <span class="kp">nil</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>

<span class="p">[</span><span class="c1">#&lt;Benchmark::Tms:0x0000000122c0aaa8</span>
  <span class="vi">@cstime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@cutime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@label</span><span class="o">=</span><span class="s2">"nil?"</span><span class="p">,</span>
  <span class="vi">@real</span><span class="o">=</span><span class="mf">0.09058699999877717</span><span class="p">,</span>
  <span class="vi">@stime</span><span class="o">=</span><span class="mf">0.0007450000000000095</span><span class="p">,</span>
  <span class="vi">@total</span><span class="o">=</span><span class="mf">0.09056200000000002</span><span class="p">,</span>
  <span class="vi">@utime</span><span class="o">=</span><span class="mf">0.08981700000000001</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="c1">#&lt;Benchmark::Tms:0x0000000122c0a968</span>
  <span class="vi">@cstime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@cutime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@label</span><span class="o">=</span><span class="s2">"=="</span><span class="p">,</span>
  <span class="vi">@real</span><span class="o">=</span><span class="mf">0.07575299999734852</span><span class="p">,</span>
  <span class="vi">@stime</span><span class="o">=</span><span class="mf">0.0001769999999999966</span><span class="p">,</span>
  <span class="vi">@total</span><span class="o">=</span><span class="mf">0.075752</span><span class="p">,</span> <span class="err">👑👑👑</span>
  <span class="vi">@utime</span><span class="o">=</span><span class="mf">0.075575</span><span class="o">&gt;</span><span class="p">]</span> 
</code></pre></div></div>

<h2 id="rubys-set-class-performance">Ruby’s <code class="highlighter-rouge">Set</code> class performance</h2>

<p>The performance of the <code class="highlighter-rouge">Set</code> class, can be worse than building a hash lookup table in some cases.</p>

<p>Take a look at this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'benchmark'</span>

<span class="n">s_array</span> <span class="o">=</span> <span class="no">Set</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]</span>
<span class="n">s_hash</span> <span class="o">=</span> <span class="no">Set</span><span class="p">[{</span><span class="ss">x: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">y: </span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="ss">x: </span><span class="mi">3</span><span class="p">,</span> <span class="ss">y: </span><span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="ss">x: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">y: </span><span class="mi">6</span><span class="p">}]</span>
<span class="n">s_string</span> <span class="o">=</span> <span class="no">Set</span><span class="p">[</span><span class="s1">'1_2'</span><span class="p">,</span> <span class="s1">'3_4'</span><span class="p">,</span> <span class="s1">'5_6'</span><span class="p">]</span>
<span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="mi">2</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">},</span> <span class="mi">3</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="mi">4</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">},</span> <span class="mi">5</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="mi">6</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">}}</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="no">Benchmark</span><span class="p">.</span><span class="nf">bm</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s1">'Set#include? Array'</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="n">s_array</span><span class="p">.</span><span class="nf">include?</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="p">}</span> <span class="p">}</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s1">'Set#include? Hash'</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="n">s_hash</span><span class="p">.</span><span class="nf">include?</span><span class="p">({</span><span class="ss">x: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">y: </span><span class="mi">2</span><span class="p">})</span> <span class="p">}</span> <span class="p">}</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s1">'Set#include? String'</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="n">s_string</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"1_2"</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s1">'[]'</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="n">h</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>

<span class="p">[</span><span class="c1">#&lt;Benchmark::Tms:0x000000011ee4ff60</span>
  <span class="vi">@cstime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@cutime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@label</span><span class="o">=</span><span class="s2">"Set#include? Array"</span><span class="p">,</span>
  <span class="vi">@real</span><span class="o">=</span><span class="mf">0.3224740000005113</span><span class="p">,</span>
  <span class="vi">@stime</span><span class="o">=</span><span class="mf">0.0011849999999999916</span><span class="p">,</span>
  <span class="vi">@total</span><span class="o">=</span><span class="mf">0.3223769999999999</span><span class="p">,</span>
  <span class="vi">@utime</span><span class="o">=</span><span class="mf">0.3211919999999999</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="c1">#&lt;Benchmark::Tms:0x000000011ee4fd30</span>
  <span class="vi">@cstime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@cutime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@label</span><span class="o">=</span><span class="s2">"Set#include? Hash"</span><span class="p">,</span>
  <span class="vi">@real</span><span class="o">=</span><span class="mf">0.4202399999994668</span><span class="p">,</span>
  <span class="vi">@stime</span><span class="o">=</span><span class="mf">0.0027610000000000134</span><span class="p">,</span>
  <span class="vi">@total</span><span class="o">=</span><span class="mf">0.4201859999999997</span><span class="p">,</span>
  <span class="vi">@utime</span><span class="o">=</span><span class="mf">0.4174249999999997</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="c1">#&lt;Benchmark::Tms:0x000000011ee4fbf0</span>
  <span class="vi">@cstime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@cutime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@label</span><span class="o">=</span><span class="s2">"Set#include? String"</span><span class="p">,</span>
  <span class="vi">@real</span><span class="o">=</span><span class="mf">0.08109800000238465</span><span class="p">,</span>
  <span class="vi">@stime</span><span class="o">=</span><span class="mf">0.0010399999999999299</span><span class="p">,</span>
  <span class="vi">@total</span><span class="o">=</span><span class="mf">0.0810949999999997</span><span class="p">,</span> <span class="err">🚀🚀🚀</span>
  <span class="vi">@utime</span><span class="o">=</span><span class="mf">0.08005499999999977</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="c1">#&lt;Benchmark::Tms:0x000000011ee4fa60</span>
  <span class="vi">@cstime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@cutime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
  <span class="vi">@label</span><span class="o">=</span><span class="s2">"[]"</span><span class="p">,</span>
  <span class="vi">@real</span><span class="o">=</span><span class="mf">0.0856240000030084</span><span class="p">,</span>
  <span class="vi">@stime</span><span class="o">=</span><span class="mf">0.0006800000000000139</span><span class="p">,</span>
  <span class="vi">@total</span><span class="o">=</span><span class="mf">0.08562099999999973</span><span class="p">,</span> <span class="err">🚀</span>
  <span class="vi">@utime</span><span class="o">=</span><span class="mf">0.08494099999999971</span><span class="o">&gt;</span><span class="p">]</span>
</code></pre></div></div>

<p>Depending on the use case, it might be better to use a hash lookup table instead of a <code class="highlighter-rouge">Set</code>. <br />
If you’re working with strings, the <code class="highlighter-rouge">Set</code> class is the best choice!</p>


<hr />

<a href="/2024/shell-curry/" style="text-decoration:none;">⬅️ Read previous</a>

<a href="/2024/bare-metal-ruby-hosting-caddy-puma-systemd/" style="float: right; text-decoration:none;">Read next ➡️</a>

    </main>

    <footer>
  <p style="text-align:center"><strong>
    <a href="/feed.xml">Feed</a>
  </strong></p>

  <hr />

  <h6>Imprint</h6>
  <p>
    <strong>Simon Neutert</strong><br />
    <span id="imprint-address">
      Postfach 1120, 55258 Ingelheim
    </span>
  </p>
  <p style="text-align:center"><strong>
    Generated using <a href="https://www.bridgetownrb.com">Bridgetown</a>
  </strong></p>
</footer>

  </body>
</html>

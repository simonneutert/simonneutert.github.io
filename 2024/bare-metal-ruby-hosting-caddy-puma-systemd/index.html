<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />


<title>Hosting a Ruby/Roda app on bare metal with Caddy, Puma and systemd (VPS setup) | Simon Neutert</title>

<meta name="description" content="I am a Ruby (on Rails) developer and open source enthusiast. Super interest in Clojure. Based in Ingelheim, next to Mainz and Wiesbaden (Rhein-Main)." />

<link rel="stylesheet" href="/_bridgetown/static/index.POPT2NFP.css" data-turbo-track="reload" />

<script src="/_bridgetown/static/index.Q4PHQU7R.js" data-turbo-track="reload" defer></script>


    <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Simon Neutert" />
  </head>
  <body class="post ">
    <header>
  <!-- 
  <img src="/images/logo.svg" alt="Logo" />
  -->
</header>

<nav>
  <ul>
    <li><a href="/">Home</a></li>
    <!-- <li><a href="/telegram">On Telegram</a></li> -->
    <!-- <li><a href="/about">About</a></li> -->
    <li><a href="/posts">Blog</a></li>
  </ul>
</nav>


    <main>
      <a href="/posts" style="text-decoration:none; text-align=center;">↖️ Show all posts</a>

<hr />

<h1>Hosting a Ruby/Roda app on bare metal with Caddy, Puma and systemd (VPS setup)</h1>

<p>For years, I’ve been using <a href="https://traefik.io">traefik</a> as a reverse proxy. It was configured to tap into the docker socket and route requests to appropriate containers using docker labels.</p>

<p>While this setup has served me well, I was ready to explore something new.</p>

<p>I’d been hearing great things about <a href="https://caddyserver.com">Caddy</a> and wanted to give it a try. Inspired by DHH’s notable departure from cloud services, I decided to host my Roda app on “bare metal” (specifically, a VPS with ARM) using Caddy and Puma.</p>

<h2 id="preparing-debian-for-ruby">Preparing debian for ruby</h2>

<p>APT packages:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\</span>
  build-essential <span class="se">\</span>
  direnv <span class="se">\</span>
  fail2ban <span class="se">\</span>
  fonts-firacode <span class="se">\</span>
  git <span class="se">\</span>
  libcurl4-openssl-dev <span class="se">\</span>
  libffi-dev <span class="se">\</span>
  libjemalloc2 <span class="se">\</span>
  libpq-dev <span class="se">\</span>
  libreadline-dev <span class="se">\</span>
  libsqlite3-dev <span class="se">\</span>
  libssl-dev <span class="se">\</span>
  libxml2-dev <span class="se">\</span>
  libxslt1-dev <span class="se">\</span>
  libyaml-dev <span class="se">\</span>
  neovim <span class="se">\</span>
  postgresql-common <span class="se">\</span>
  postgresql-16 <span class="se">\</span>
  slirp4netns <span class="se">\</span>
  software-properties-common <span class="se">\</span>
  sqlite3 <span class="se">\</span>
  ufw <span class="se">\</span>
  uidmap <span class="se">\</span>
  zlib1g-dev <span class="se">\</span>
  zsh
</code></pre></div></div>

<h2 id="securing-the-server">Securing the server</h2>

<p>For more detailed information, check out <a href="https://www.simon-neutert.de/2022/setup-vps/">this guide</a>.</p>

<h3 id="1-ssh-login-with-keys-only">1. SSH login with keys only</h3>

<p>Security best practice: Always use SSH keys instead of password authentication.</p>

<h3 id="2-fail2ban-on-debian">2. Fail2ban on Debian</h3>

<p>Fail2ban requires a simple setup step on Debian:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo touch</span> /var/log/auth.log
</code></pre></div></div>

<h3 id="3-ufw">3. UFW</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>ufw default deny incoming
<span class="nb">sudo </span>ufw default allow outgoing
<span class="nb">sudo </span>ufw allow 22/tcp
<span class="nb">sudo </span>ufw allow 80/tcp
<span class="nb">sudo </span>ufw allow 443/tcp
<span class="nb">sudo </span>ufw show added
<span class="nb">sudo </span>ufw <span class="nb">enable</span>
</code></pre></div></div>

<h3 id="4-setting-up-a-comfortable-environment">4. Setting up a comfortable environment</h3>

<p>Before proceeding further, reboot your server.</p>

<p>I took some time to make the server environment more developer-friendly by installing:</p>

<ul>
  <li><code class="highlighter-rouge">zsh</code> as the default shell instead of <code class="highlighter-rouge">bash</code>, with useful configurations:
    <ul>
      <li><code class="highlighter-rouge">setopt autocd</code> for easier directory navigation</li>
      <li><code class="highlighter-rouge">setopt share_history</code> for shared command history</li>
      <li><code class="highlighter-rouge">setopt HIST_IGNORE_ALL_DUPS</code> to maintain a clean command history</li>
    </ul>
  </li>
  <li>Modern CLI tools:
    <ul>
      <li><code class="highlighter-rouge">zoxide</code> for smarter directory navigation</li>
      <li><code class="highlighter-rouge">eza</code> as a modern replacement for <code class="highlighter-rouge">ls</code></li>
      <li><a href="https://starship.rs">starship</a> for an enhanced prompt</li>
      <li><code class="highlighter-rouge">atuin</code> for shell history management</li>
      <li><code class="highlighter-rouge">neovim</code> as the text editor</li>
    </ul>
  </li>
  <li>ZSH enhancements:
    <ul>
      <li>zsh-autocomplete</li>
      <li>zsh-autosuggestions</li>
      <li>zsh-syntax-highlighting</li>
    </ul>
  </li>
  <li>Development tools:
    <ul>
      <li><a href="https://github.com/casey/just">just</a> for command running</li>
      <li><a href="https://asdf-vm.com">asdf</a> for version management</li>
      <li><code class="highlighter-rouge">direnv</code> for environment management</li>
      <li><code class="highlighter-rouge">httpie</code> for API testing</li>
    </ul>
  </li>
</ul>

<h2 id="caddy">Caddy</h2>

<p>The Caddy installation process is straightforward and won’t be covered here.</p>

<p>Here’s the Caddyfile configuration for serving assets, static files, and vendor files:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>this-is.myapp.com <span class="o">{</span>
	handle /assets/<span class="k">*</span> <span class="o">{</span>
    root <span class="k">*</span> /home/deploy/myapp/public/assets
    file_server
  <span class="o">}</span>
  handle /vendor/<span class="k">*</span> <span class="o">{</span>
    root <span class="k">*</span> /home/deploy/myapp/public/vendor
    file_server
  <span class="o">}</span>
	handle <span class="o">{</span>
		reverse_proxy :9292
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="asdf">ASDF</h2>

<p>Initialize asdf with the necessary plugins (ymmv):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asdf plugin-add ruby
asdf plugin-add rust
asdf plugin-add deno
asdf plugin-add just
asdf <span class="nb">install </span>rust 1.72.1 <span class="o">&amp;&amp;</span> asdf global rust 1.72.1
<span class="nb">export </span><span class="nv">RUBY_CONFIGURE_OPTS</span><span class="o">=</span><span class="nt">--enable-yjit</span> <span class="c"># you WANT yjit!!!</span>
<span class="nb">cd</span> /var/www/myapp/code <span class="o">&amp;&amp;</span> asdf <span class="nb">install</span>
</code></pre></div></div>

<h2 id="systemd">Systemd</h2>

<p>Here’s a template for environment variables in systemd (save as <code class="highlighter-rouge">puma.conf</code> - it is referenced in the systemd service file):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">RUBY_YJIT_ENABLE</span><span class="o">=</span>1
<span class="nv">RUBY_CONFIGURE_OPTS</span><span class="o">=</span><span class="s2">"--enable-yjit --with-jemalloc --yjit-mem-size=256 --yjit-code-gc"</span>
</code></pre></div></div>

<p><a href="https://docs.ruby-lang.org/en/master/yjit/yjit_md.html#label-Examples">YJIT docs</a>
☝️ For the <code class="highlighter-rouge">--yjit-mem-size</code> value and jemalloc configuration, consult the documentation and your specific needs.</p>

<p>Use <code class="highlighter-rouge">which bundler</code> to locate the bundler executable path. Adjust the following systemd service file according to your paths and user:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]    
<span class="nv">Description</span><span class="o">=</span>My angry little Puma HTTP Server    
<span class="nv">After</span><span class="o">=</span>network.target

<span class="o">[</span>Service]
<span class="c"># Puma supports systemd's `Type=notify` and watchdog service</span>
<span class="c"># monitoring, as of Puma 5.1 or later.</span>
<span class="c"># On earlier versions of Puma or JRuby, change this to `Type=simple` and remove</span>
<span class="c"># the `WatchdogSec` line.</span>
<span class="nv">Type</span><span class="o">=</span>notify

<span class="c"># If your Puma process locks up, systemd's watchdog will restart it within seconds.</span>
<span class="nv">WatchdogSec</span><span class="o">=</span>10

<span class="c"># Preferably configure a non-privileged user</span>
<span class="c"># User=mynonsudouser</span>

<span class="c"># The path to your application code root directory.</span>
<span class="c"># Also replace the "&lt;YOUR_APP_PATH&gt;" placeholders below with this path.</span>
<span class="nv">WorkingDirectory</span><span class="o">=</span>/var/www/myapp/code

<span class="c"># Helpful for debugging socket activation, etc.</span>
<span class="c"># Environment=PUMA_DEBUG=1</span>
<span class="nv">EnvironmentFile</span><span class="o">=</span>/home/mynonsudouser/puma.conf

<span class="c"># SystemD will not run puma even if it is in your path. You must specify</span>
<span class="c"># an absolute URL to puma. For example /usr/local/bin/puma</span>
<span class="nv">ExecStart</span><span class="o">=</span>/home/mynonsudouser/.asdf/shims/bundler <span class="nb">exec </span>puma <span class="nt">-C</span> /var/www/mynonsudouser/code/config/puma/production.rb <span class="nt">-p9292</span>
    
<span class="nv">Restart</span><span class="o">=</span>always    
    
<span class="o">[</span>Install]    
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<h2 id="systemctl">systemctl</h2>

<p>Finally, enable and start the service:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl <span class="nb">enable </span>puma.service
<span class="nb">sudo </span>systemctl start puma.service
</code></pre></div></div>

<p>🚀</p>


<hr />

<a id="btn-previous" href="/2024/ruby-til/" style="text-decoration:none;">⬅️ Read previous</a>

<a id="btn-next" href="/2024/with-postgres/" style="float: right; text-decoration:none;">Read next ➡️</a>

    </main>

    <footer>
  <p style="text-align:center"><strong>
    <a href="/feed.xml">Feed</a>
  </strong></p>

  <hr />

  <h6>Imprint</h6>
  <p>
    <strong>Simon Neutert</strong><br />
    <span id="imprint-address">
      Postfach 1120, 55258 Ingelheim
    </span>
  </p>
  <p style="text-align:center"><strong>
    Generated using <a href="https://www.bridgetownrb.com">Bridgetown</a>
  </strong></p>
</footer>

  </body>
</html>

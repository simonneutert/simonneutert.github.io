name: Add deno-starshower Starred Repos to Bridgetown Blog

on:
  # Run on manual trigger
  workflow_dispatch:
  # Or run on a schedule (e.g., weekly on Sundays at midnight UTC)
  schedule:
    - cron: '0 0 * * 0'
  # Or run on pushes to main (if you want it to update with every blog post)
  # push:
  #   branches: [ main ]

# Grant permissions for creating pull requests
permissions:
  contents: write
  pull-requests: write

# Prevent multiple runs from updating the same PR simultaneously
concurrency:
  group: update-starred-repos
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout blog repository
        uses: actions/checkout@v4
        # This checks out YOUR blog repository where this workflow file lives
        # If this workflow is in a different repo than your blog, specify:
        # with:
        #   repository: your-username/your-blog-repo

      - name: Checkout deno-starshower
        uses: actions/checkout@v4
        with:
          repository: simonneutert/deno-starshower
          # Or use your fork: <your-username>/deno-starshower
          path: .deno-starshower
          # This checks out deno-starshower into a subdirectory

      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Generate starred repos markdown
        working-directory: .deno-starshower
        env:
          GITHUB_STARSHOWER: ${{ secrets.GITHUB_TOKEN }}
          # Or use a custom PAT for higher rate limits:
          # GITHUB_STARSHOWER: ${{ secrets.GITHUB_PAT }}
        run: |
          deno run --allow-env --allow-net --allow-write main.ts ${{ github.repository_owner }}
          # Alternative: hardcode username instead of using a variable:
          # deno run --allow-env --allow-net --allow-write main.ts simonneutert

      - name: Prepare starred repos for Jekyll
        run: |
          # Create target directory if it doesn't exist (adjust path as needed)
          mkdir -p src
          
          # Copy the generated markdown and add Jekyll front matter
          cat > src/starred-repos.md << 'EOF'
          ---
          layout: page
          title: My Starred Repositories on GitHub
          ---
          
          EOF
          
          tail -n +2 .deno-starshower/deno-starshower_output/Starred_Repos.md >> src/starred-repos.md
          
          # remove the generated directory of the starshower checkout
          rm -rf .deno-starshower
    
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: Update starred repositories list
          branch: update-starred-repos
          delete-branch: true
          title: 'ðŸŒŸ Update starred repositories list'
          body: |
            ## Automated Update
            
            This PR updates the starred repositories list with the latest data from GitHub.
            
            - Generated by: deno-starshower
            - Triggered by: ${{ github.event_name }}
            - Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            **Changes:**
            - Updated `src/starred-repos.md` with latest starred repositories
            
            ---
            *This is an automated PR. Review and merge if the changes look correct.*
          labels: |
            automated
            content-update
          assignees: ${{ github.repository_owner }}


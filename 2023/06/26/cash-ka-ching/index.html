<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />


<title>I coded a cash register backend in Ruby backed by Postgres | Simon Neutert</title>

<meta name="description" content="I am a Ruby (on Rails) developer and open source enthusiast. Super interest in Clojure. Based in Ingelheim, next to Mainz and Wiesbaden (Rhein-Main)." />

<link rel="stylesheet" href="/_bridgetown/static/index.IEH6LJYO.css" data-turbo-track="reload" />

<script src="/_bridgetown/static/index.MGEJV2MU.js" data-turbo-track="reload" defer></script>


    <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Simon Neutert" />
  </head>
  <body class="post ">
    <header role="banner">
  <!-- 
  <img src="/images/logo.svg" alt="Logo" />
  -->
</header>

<nav role="navigation" aria-label="Hauptnavigation">
  <ul>
    <li>
      <a href="/" >Home</a>
    </li>
    <li>
      <a href="/posts" >Blog</a>
    </li>
  </ul>
</nav>


    <main>
      <a href="/posts" style="text-decoration:none; text-align=center;">‚ÜñÔ∏è Show all posts</a>

<hr />

<article>

<h1>I coded a cash register backend in Ruby backed by Postgres</h1>

<p>I‚Äôve been working on a cash register backend in Ruby for the past few months after work and sometimes on weekends. It‚Äôs been a fun project and I‚Äôve learned a lot about Ruby, Postgres, and how to keep calm and trash the hell out of ideas.</p>

<p>Again, as readers of my blog will guess, I bet my horses on Roda and Sequel. I‚Äôve been using them for a while now and I‚Äôm very happy with them. I‚Äôve also been using Postgres for a while now and I‚Äôm very happy with it too. I‚Äôm not sure if I‚Äôll ever use MySQL again ü§≠</p>

<p>My main idea was to play with Postgres‚Äô locking mechanisms and see if I could build a cash register backend that could handle multiple concurrent requests. I wanted to eliminate the ever so slight chance of concurrent requests messing up the cash register‚Äôs state. I also wanted to see if this would slim down the logic part in the backend code.</p>

<h4 id="tldr">TLDR</h4>

<p>I think I‚Äôve succeeded in building a cash register backend that can handle multiple concurrent requests. I‚Äôve also managed to slim down the logic part in the backend code. I‚Äôm not sure if someone will ever use this in production, but it‚Äôs been a fun project and I‚Äôve learned a lot.</p>

<ul>
  <li><a href="https://github.com/simonneutert/ka-ching-backend">ka-ching-backend</a></li>
  <li><a href="https://github.com/simonneutert/ka-ching-client">ka-ching-client</a></li>
</ul>

<p>There is also a demo to showcase the API and the client in conjunction. It‚Äôs a simple Roda app with <a href="https://htmx.org/">htmx</a> for the frontend. It‚Äôs not pretty, but it works.</p>

<p><a href="https://github.com/simonneutert/ka-ching-demo">Check out the demo repository on GitHub</a>!</p>

<h2 id="table-of-contents">Table of contents<!-- omit in toc --></h2>

<ul>
  <li><a href="#the-cash-register">The cash register</a>
    <ul>
      <li><a href="#what-this-this-system-is-not-intended-to-bedo">What this this system is not intended to be/do</a></li>
    </ul>
  </li>
  <li><a href="#its-architecture-a-micro-monolith">It‚Äôs Architecture? A Micro-Monolith!</a></li>
  <li><a href="#implementing-the-backend-with-roda-and-sequel">Implementing the backend with Roda and Sequel</a>
    <ul>
      <li><a href="#my-goals-for-the-backend">My goals for the backend</a></li>
      <li><a href="#database-lockings-with-sequel">Database Lockings with Sequel</a></li>
      <li><a href="#learning-more-about-roda-and-sequel">Learning more about Roda and Sequel</a></li>
    </ul>
  </li>
</ul>

<h2 id="the-cash-register">The cash register</h2>

<p>The cash register is a simple machine that can handle the following operations:</p>

<ul>
  <li>Wrap transactions of the cash register for a certain period of time</li>
  <li>Add money to the cash register (deposit)</li>
  <li>Remove money from the cash register (withdraw)</li>
  <li>Get the current state of the cash register (saldo)</li>
  <li>Get the history of the cash register (list of transactions)</li>
  <li>Track certain events in an audit log (e.g. when the cash register was reopened, after it was closed)</li>
</ul>

<h3 id="what-this-this-system-is-not-intended-to-bedo">What this this system is not intended to be/do</h3>

<ul>
  <li>The cash register is not a point of sale (POS) system.</li>
  <li>It‚Äôs not meant to be used by a cashier to scan items and print receipts.</li>
  <li>It‚Äôs not meant to be used by a customer to pay for their groceries.</li>
  <li>It‚Äôs not meant to be used by a manager to get reports on the sales of the day.</li>
</ul>

<h2 id="its-architecture-a-micro-monolith">Its Architecture? A Micro-Monolith!</h2>

<p>I‚Äôve been using the term ‚Äúmicro-monolith‚Äù for a while now. I‚Äôm not sure if it‚Äôs a thing, but I like it. It‚Äôs a monolith, but it‚Äôs a small one. It‚Äôs a monolith that can easily serve as a base of something bigger oder act as a standalone system. Being a micro-monolith it cannot be split into smaller parts. It‚Äôs a monolith, but it‚Äôs a small one.</p>

<p>The main reason I struggle with calling it a microservice is, that I want it to be understood as a product and not as a service. It does not do a generic single thing. It does a specific set of things that together represent my interpretation of a cash register system. Maybe I am just too happy with <a href="https://world.hey.com/dhh/we-stand-to-save-7m-over-five-years-from-our-cloud-exit-53996caa">DHH leaving the cloud</a> and <a href="https://www.reddit.com/r/aws/comments/137lyno/amazon_prime_microservices_to_monolith/">Amazon reverting to a monolith</a> for their ‚ÄúPrime Video‚Äù. I don‚Äôt know.</p>

<h2 id="implementing-the-backend-with-roda-and-sequel">Implementing the backend with Roda and Sequel</h2>

<p>It‚Äôs been a breeze! By coincidence Jeremy Evans, the maintainer of Roda and Sequel (and many more) had been the guest in <a href="https://www.youtube.com/watch?v=Hh_lqARFGcg">The Rubber Duck Dev Show</a> sharing his ideas first hand with the audience.</p>

<h3 id="my-goals-for-the-backend">My goals for the backend</h3>

<ul>
  <li>multi-tenant database architecture</li>
  <li>relies on database locks for critical operations</li>
  <li>json columns in most tables, to pass your own context</li>
  <li>fast, cheap, and reliable</li>
  <li>short and concise codebase</li>
  <li>lean on dependencies</li>
  <li>with containerization in mind</li>
  <li>have a client ready to use the API as a ruby gem</li>
</ul>

<h3 id="database-lockings-with-sequel">Database Lockings with Sequel</h3>

<p>In order to lock a table in Postgres you can use the <code class="highlighter-rouge">LOCK</code> statement. It‚Äôs a very powerful tool and can be used to lock a table in different ways. I‚Äôve been using the <code class="highlighter-rouge">ACCESS EXCLUSIVE</code> mode to lock the tables <code class="highlighter-rouge">lockings</code> and <code class="highlighter-rouge">bookings</code> in order to prevent concurrent requests from messing up the cash register‚Äôs state.</p>

<p>Looking at the code below you can see that I‚Äôm using Sequel‚Äôs <code class="highlighter-rouge">transaction</code> method to wrap the two <code class="highlighter-rouge">LOCK</code> statements and the <code class="highlighter-rouge">INSERT</code> statement into a single transaction. This way I can be sure that the two <code class="highlighter-rouge">LOCK</code> statements and the <code class="highlighter-rouge">INSERT</code> statement are executed in a single transaction. If one of the statements fails, the whole transaction is rolled back.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@conn</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="vi">@conn</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="s1">'LOCK TABLE lockings IN ACCESS EXCLUSIVE MODE'</span><span class="p">)</span>
  <span class="vi">@conn</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="s1">'LOCK TABLE bookings IN ACCESS EXCLUSIVE MODE'</span><span class="p">)</span>
  <span class="n">new_booking_id</span> <span class="o">=</span> <span class="vi">@conn_bookings</span><span class="p">.</span><span class="nf">insert</span><span class="p">(</span><span class="ss">id: </span><span class="no">SecureRandom</span><span class="p">.</span><span class="nf">uuid</span><span class="p">,</span>
                                          <span class="ss">amount_cents: </span><span class="vi">@booker</span><span class="p">.</span><span class="nf">amount_cents</span><span class="p">,</span>
                                          <span class="ss">action: </span><span class="vi">@booker</span><span class="p">.</span><span class="nf">action</span><span class="p">,</span>
                                          <span class="ss">realized: </span><span class="vi">@booker</span><span class="p">.</span><span class="nf">realized</span><span class="p">,</span>
                                          <span class="ss">context: </span><span class="vi">@booker</span><span class="p">.</span><span class="nf">context</span><span class="p">.</span><span class="nf">to_json</span><span class="p">)</span>

  <span class="n">query_bookings</span><span class="p">(</span><span class="vi">@conn</span><span class="p">).</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">id: </span><span class="n">new_booking_id</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you want to dig into what locking a table in Postgres means, I recommend reading <a href="https://www.postgresql.org/docs/current/explicit-locking.html">the Postgres Documentation on Explicit Locking</a>.</p>

<h3 id="learning-more-about-roda-and-sequel">Learning more about Roda and Sequel</h3>

<p>As the two projects play well together I learned a lot about both of them. Roda‚Äôs idea of the routing tree was a great opportunity to come up with a way of using and reusing database connections depending on where your requests are routed to. Sequel keeps things easy and straight by mostly acting as a wrapper around SQL, without applying custom object-relational mapping (ORM) logic. Hashes are the way to go and I really dig that.</p>

<p>Connecting to one of the tenant database‚Äôs looks like this currenyly:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">db_connection</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="no">Sequel</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span>
    <span class="s2">"postgres://</span><span class="si">#{</span><span class="no">DATABASE_URL</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="no">DATABASE_PORT</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">database</span><span class="si">}</span><span class="s2">?user=</span><span class="si">#{</span><span class="no">DATABASE_USER</span><span class="si">}</span><span class="s2">&amp;password=</span><span class="si">#{</span><span class="no">DATABASE_PASSWORD</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
    <span class="ss">logger: </span><span class="no">DB</span><span class="o">::</span><span class="no">LOGGER</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">block</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Utilizing the <code class="highlighter-rouge">&amp;block</code> parameter of the <code class="highlighter-rouge">Sequel.connect</code> method allows me to pass a block to the method. This way I can make sure that the connection is closed after the block has been executed. This is a great way to make sure that the connection is closed after the request has been processed.</p>


<hr />

<a id="btn-previous" href="/2023/12/18/random-podcast-episodes/" style="text-decoration:none;">‚¨ÖÔ∏è Read previous</a>

<a id="btn-next" href="/2023/06/25/pdf-png-preview/" style="float: right; text-decoration:none;">Read next ‚û°Ô∏è</a>

</article>

    </main>

    <footer>
  <p style="text-align:center"><strong>
    <a href="/feed.xml">Feed</a>
  </strong></p>

  <hr />

  <h6>Imprint</h6>
  <p>
    <strong>Simon Neutert</strong><br />
    <span id="imprint-address">
      Postfach 1120, 55258 Ingelheim
    </span>
  </p>
  <p style="text-align:center"><strong>
    Generated using <a href="https://www.bridgetownrb.com">Bridgetown</a>
  </strong></p>
</footer>

  </body>
</html>

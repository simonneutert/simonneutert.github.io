<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />


<title>Ruby REST API client for Papierkram.de | Simon Neutert</title>

<meta name="description" content="I am a Ruby (on Rails) developer and open source enthusiast. Super interest in Clojure. Based in Ingelheim, next to Mainz and Wiesbaden (Rhein-Main)." />

<link rel="stylesheet" href="/_bridgetown/static/index.IEH6LJYO.css" data-turbo-track="reload" />

<script src="/_bridgetown/static/index.XRE2XYFL.js" data-turbo-track="reload" defer></script>


    <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Simon Neutert" />
  </head>
  <body class="post ">
    <header role="banner">
  <!-- 
  <img src="/images/logo.svg" alt="Logo" />
  -->
</header>

<nav role="navigation" aria-label="Hauptnavigation">
  <ul>
    <li>
      <a href="/" >Home</a>
    </li>
    <li>
      <a href="/posts" >Blog</a>
    </li>
  </ul>
</nav>


    <main>
      <a href="/posts" style="text-decoration:none; text-align=center;">‚ÜñÔ∏è Show all posts</a>

<hr />

<article>

<h1>Ruby REST API client for Papierkram.de</h1>

<p>I have written a small REST API client for the Papierkram.de API, which is a simple wrapper around the Faraday gem. Although it‚Äôs not perfect, it works well. For the HTTP client library, I chose <a href="https://github.com/HoneyryderChuck/httpx">httpx</a>, which promises to be the future with blazing-fast performance, and it‚Äôs free too!</p>

<p>tldr; <a href="https://rubygems.org/gems/papierkram_api_client">here‚Äôs the gem</a> and <a href="https://github.com/simonneutert/papierkram_api_client">here‚Äôs the code</a>.</p>

<p>In this post, I would like to share some of the things I have learned while writing this gem.</p>

<p>Yet, there‚Äôs still some more documentation and testing to do. üòÖ</p>

<h2 id="testing-with-vcr-and-minitest">Testing with VCR and Minitest</h2>

<p>I chose to use Minitest for testing, as I am a big fan of its simplicity and think it is a great choice for testing. One of the things I like about it is that it is just plain Ruby, with no DSL, magic, or weird syntax. While I‚Äôm not certain whether it is actually faster than RSpec, it certainly feels that way.</p>

<p>Minitest pairs very well with <a href="https://github.com/vcr/vcr">VCR</a> for testing the API. Personally, I am not a big fan of mocking, so I prefer to record the API responses and replay them during testing. However, it is important to keep an eye on your recorded data to ensure that it is still valid.</p>

<p>Setting up Minitest and VCR is straightforward using <a href="https://github.com/mfpiccolo/minitest-vcr">minitest-vcr</a>.</p>

<p>Here‚Äôs an example setup of Minitest‚Äôs <code class="highlighter-rouge">test_helper.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># $ cat app_name/test/test_helper.rb</span>
<span class="nb">require</span> <span class="s2">"minitest/autorun"</span>
<span class="nb">require</span> <span class="s2">"minispec-metadata"</span>
<span class="nb">require</span> <span class="s2">"vcr"</span>
<span class="nb">require</span> <span class="s2">"minitest-vcr"</span>
<span class="nb">require</span> <span class="s2">"faraday"</span>

<span class="no">VCR</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">cassette_library_dir</span> <span class="o">=</span> <span class="s1">'test/cassettes'</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">hook_into</span> <span class="ss">:faraday</span>
<span class="k">end</span>

<span class="no">MinitestVcr</span><span class="o">::</span><span class="no">Spec</span><span class="p">.</span><span class="nf">configure!</span>
</code></pre></div></div>

<p>It will record the request and the response. But it will also record the request headers. And if you don‚Äôt pay attention,
you might end up with a recorded response that leaks personal or credential data.</p>

<p>So make sure to filter out any sensitive data from the request headers.</p>

<p>VCR brings some features that will help <a href="https://benoittgt.github.io/vcr/#/configuration/filter_sensitive_data">you with that</a>.
You can filter out parts of the request headers, like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">interaction</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'set-cookie'</span><span class="p">].</span><span class="nf">first</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">).</span><span class="nf">first</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">).</span><span class="nf">last</span>
</code></pre></div></div>

<p>OR you can filter out the whole request headers:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">VCR</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="c1"># ...</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">filter_sensitive_data</span><span class="p">(</span><span class="s1">'&lt;API_KEY&gt;'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">interaction</span><span class="o">|</span>
   <span class="n">interaction</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'X-Http-Username'</span><span class="p">]</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Filter out a secret value coming from the environment:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">VCR</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="c1"># ...</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">filter_sensitive_data</span><span class="p">(</span><span class="s1">'&lt;API_KEY&gt;'</span><span class="p">)</span> <span class="p">{</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'PAPIERKRAM_API_KEY'</span><span class="p">]</span> <span class="p">}</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This will help you avoid leaking sensitive data that you are aware of and can pin down exactly.</p>

<p>Filtering emails is a bit more tricky. You can filter out the whole email address in most cases something like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># tests ...</span>
<span class="no">VCR</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="c1"># ...</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">before_record</span> <span class="k">do</span> <span class="o">|</span><span class="n">interaction</span><span class="o">|</span>
    <span class="n">interaction</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">scan</span><span class="p">(</span><span class="sr">/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}\b/</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">email</span><span class="o">|</span>
      <span class="n">interaction</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">gsub!</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="s1">'&lt;EMAIL&gt;'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="clean-your-cassette-files-once-in-a-while">Clean your cassette files once in a while</h2>

<p>I know there are auto-clean options in VCR, but in most cases, I can manage it myself. APIs usually don‚Äôt change that often or change gradually enough.</p>

<p>Deleting the cassettes a few times a year or after API changes have been communicated should be sufficient.</p>

<h2 id="check-out-the-code-of-the-gem">Check out the code of the gem</h2>

<p>If you want to see how I implemented the gem, you can check out the code on <a href="https://github.com/simonneutert/papierkram_api_client">GitHub</a>.
Please, provide feedback if you have any. I am always happy to learn something new. And if you have any questions, feel free to ask.</p>

<h2 id="conclusion">Conclusion</h2>

<p>It‚Äôs always fun to put something together that you can use in your own projects. Working on this gem was a great learning experience for me.
Implementing Minitest, VCR, configuring Faraday and Rubocop, direnv and setting up GitHub Actions was a great way to learn more about Ruby and its ecosystem.
I want to maintain a Changelog.md file for this gem, so I (you) can keep track of the changes and document them.
I will also add some more tests and documentation in the future.</p>


<hr />

<a id="btn-previous" href="/2023/pdf-png-preview/" style="text-decoration:none;">‚¨ÖÔ∏è Read previous</a>

<a id="btn-next" href="/2023/before-christ-postgres-sequel/" style="float: right; text-decoration:none;">Read next ‚û°Ô∏è</a>

</article>

    </main>

    <footer>
  <p style="text-align:center"><strong>
    <a href="/feed.xml">Feed</a>
  </strong></p>

  <hr />

  <h6>Imprint</h6>
  <p>
    <strong>Simon Neutert</strong><br />
    <span id="imprint-address">
      Postfach 1120, 55258 Ingelheim
    </span>
  </p>
  <p style="text-align:center"><strong>
    Generated using <a href="https://www.bridgetownrb.com">Bridgetown</a>
  </strong></p>
</footer>

  </body>
</html>

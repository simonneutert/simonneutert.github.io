<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />


<title>Sync Directories with Ruby (no deletion) | Simon Neutert</title>

<meta name="description" content="I am a Ruby (on Rails) developer and open source enthusiast. Super interest in Clojure. Based in Ingelheim, next to Mainz and Wiesbaden (Rhein-Main)." />

<link rel="stylesheet" href="/_bridgetown/static/index.POPT2NFP.css" data-turbo-track="reload" />

<script src="/_bridgetown/static/index.KGKIVIBR.js" data-turbo-track="reload" defer></script>


    <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Simon Neutert" />
  </head>
  <body class="post ">
    <header>
  <!-- 
  <img src="/images/logo.svg" alt="Logo" />
  -->
</header>

<nav>
  <ul>
    <li><a href="/">Home</a></li>
    <!-- <li><a href="/telegram">On Telegram</a></li> -->
    <!-- <li><a href="/about">About</a></li> -->
    <li><a href="/posts">Blog</a></li>
  </ul>
</nav>


    <main>
      <a href="/posts" style="text-decoration:none; text-align=center;">↖️ Show all posts</a>

<hr />

<h1>Sync Directories with Ruby (no deletion)</h1>

<p>In order to automate my Jekyll workflow, I thought about writing a bash script first. But why not use Ruby instead?</p>

<p>Inspiration was found <a href="https://www.infoq.com/articles/ruby-file-upload-ssh-intro">here</a>, where Matthew Bass wrote a nice little article dated 2007. Though its simplicity made it easy to grasp, the script had some flaws. If you used an FTP client for your first upload, and the directories of your project would change or would never be deeper than one level - you are good to go.</p>

<p>Yet my project had nested directories and thanks to progress, the gems wouldn&#8217;t work quite the same as in the old days of 2007.</p>

<p><strong>Attention:</strong> my script isn&#8217;t perfect, because it is fine for me as it is. One thing, that would enhance it quite a bit, would be parsing a config file, instead of setting the variable in the method itself ;-) feel free!</p>

<p>Contribute to this script on <a href="https://github.com/simonneutert/ruby-sftp-sync">GitHub</a></p>

<p>Prepare the gems:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># read more: https://github.com/net-ssh</span>
<span class="nv">$ </span>gem <span class="nb">install </span>net-ssh
<span class="nv">$ </span>gem <span class="nb">install </span>net-sftp
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'net/ssh'</span>
<span class="nb">require</span> <span class="s1">'net/sftp'</span>
<span class="nb">require</span> <span class="s1">'find'</span>
<span class="nb">require</span> <span class="s1">'io/console'</span>
<span class="nb">require</span> <span class="s1">'pry'</span>

<span class="c1"># unpolute namespace</span>
<span class="nb">require</span> <span class="s1">'net/ssh'</span>
<span class="nb">require</span> <span class="s1">'net/sftp'</span>
<span class="nb">require</span> <span class="s1">'find'</span>
<span class="nb">require</span> <span class="s1">'io/console'</span>
<span class="nb">require</span> <span class="s1">'pry'</span>

<span class="c1"># unpolute namespace</span>
<span class="k">module</span> <span class="nn">Upload2SFTP</span>

  <span class="k">class</span> <span class="nc">Server</span>
    <span class="nb">attr_reader</span> <span class="ss">:host_url</span><span class="p">,</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:password</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">host_url</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
      <span class="vi">@host_url</span> <span class="o">=</span> <span class="n">host_url</span>
      <span class="vi">@username</span> <span class="o">=</span> <span class="n">username</span>
      <span class="vi">@password</span> <span class="o">=</span> <span class="n">password</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Client</span>
    <span class="nb">attr_reader</span> <span class="ss">:local_path</span><span class="p">,</span> <span class="ss">:remote_path</span><span class="p">,</span> <span class="ss">:dir_perm</span><span class="p">,</span> <span class="ss">:file_perm</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">dir_perm</span><span class="p">,</span> <span class="n">file_perm</span><span class="p">)</span>
      <span class="vi">@local_path</span> <span class="o">=</span> <span class="n">local_path</span>
      <span class="vi">@remote_path</span> <span class="o">=</span> <span class="n">remote_path</span>
      <span class="vi">@file_perm</span> <span class="o">=</span> <span class="n">file_perm</span>
      <span class="vi">@dir_perm</span> <span class="o">=</span> <span class="n">dir_perm</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">upload</span>
    <span class="n">host_url</span> <span class="o">=</span> <span class="s1">'yourdomain.com'</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s1">'xyz'</span>
    <span class="nb">p</span> <span class="s2">"Enter SSH/SFTP Password for user </span><span class="si">#{</span><span class="n">username</span><span class="si">}</span><span class="s2">:"</span>
    <span class="n">password</span> <span class="o">=</span> <span class="no">STDIN</span><span class="p">.</span><span class="nf">noecho</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:gets</span><span class="p">).</span><span class="nf">chomp</span> <span class="c1"># hidden user input</span>
    <span class="n">server</span> <span class="o">=</span> <span class="no">Server</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">host_url</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="n">local_path</span> <span class="o">=</span> <span class="s1">'./_site'</span>
    <span class="n">remote_path</span> <span class="o">=</span> <span class="s1">'/httpdocs/public_html'</span>
    <span class="n">file_perm</span> <span class="o">=</span> <span class="mi">0</span><span class="n">o644</span>
    <span class="n">dir_perm</span> <span class="o">=</span> <span class="mi">0</span><span class="n">o755</span>
    <span class="n">client</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">dir_perm</span><span class="p">,</span> <span class="n">file_perm</span><span class="p">)</span>

    <span class="nb">puts</span> <span class="s1">'Connecting to remote server'</span>
    <span class="no">Net</span><span class="o">::</span><span class="no">SSH</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="nf">host_url</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="nf">username</span><span class="p">,</span> <span class="ss">password: </span><span class="n">server</span><span class="p">.</span><span class="nf">password</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ssh</span><span class="o">|</span>
      <span class="n">ssh</span><span class="p">.</span><span class="nf">sftp</span><span class="p">.</span><span class="nf">connect</span> <span class="k">do</span> <span class="o">|</span><span class="n">sftp</span><span class="o">|</span>
        <span class="nb">puts</span> <span class="s1">'Checking for files which need updating'</span>
        <span class="no">Find</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">local_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
          <span class="k">next</span> <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="nf">directory?</span>
          <span class="n">local_file</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">to_s</span>
          <span class="n">remote_file</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">remote_path</span> <span class="o">+</span> <span class="n">local_file</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
          <span class="n">remote_dir</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">remote_file</span><span class="p">)</span>

          <span class="n">upload_dir</span><span class="p">(</span><span class="n">sftp</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">remote_dir</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>
          <span class="n">upload_file</span><span class="p">(</span><span class="n">sftp</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="nb">puts</span> <span class="s1">'Disconnecting from remote server'</span>
    <span class="nb">puts</span> <span class="s1">'File transfer complete'</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">upload_dir</span><span class="p">(</span><span class="n">sftp</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">remote_dir</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>
      <span class="c1"># directory exists?</span>
      <span class="n">sftp</span><span class="p">.</span><span class="nf">dir</span><span class="p">.</span><span class="nf">entries</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>
    <span class="k">rescue</span> <span class="no">Net</span><span class="o">::</span><span class="no">SFTP</span><span class="o">::</span><span class="no">StatusException</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="k">raise</span> <span class="k">unless</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="nf">code</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="nf">code</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
      <span class="c1"># parse directory structure from file(path)</span>
      <span class="n">dir_structure</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">local_file</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">local_path</span><span class="p">,</span> <span class="s1">''</span><span class="p">))[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
      <span class="c1"># create directory and subdirectories if they do not exist</span>
      <span class="n">create_directory</span><span class="p">(</span><span class="n">sftp</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">dir_structure</span><span class="p">,</span> <span class="n">remote_dir</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">upload_file</span><span class="p">(</span><span class="n">sftp</span><span class="p">,</span> <span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>
      <span class="c1"># does the file exist?</span>
      <span class="n">rstat</span> <span class="o">=</span> <span class="n">sftp</span><span class="p">.</span><span class="nf">file</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">remote_file</span><span class="p">).</span><span class="nf">stat</span>
      <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">local_file</span><span class="p">).</span><span class="nf">mtime</span> <span class="o">&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="n">rstat</span><span class="p">.</span><span class="nf">mtime</span><span class="p">)</span>
        <span class="c1"># update file</span>
        <span class="n">sftp</span><span class="p">.</span><span class="nf">upload!</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">)</span>
        <span class="nb">puts</span> <span class="s2">"updating </span><span class="si">#{</span><span class="n">remote_file</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
    <span class="k">rescue</span> <span class="no">Net</span><span class="o">::</span><span class="no">SFTP</span><span class="o">::</span><span class="no">StatusException</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="k">raise</span> <span class="k">unless</span> <span class="n">e</span><span class="p">.</span><span class="nf">code</span> <span class="o">==</span> <span class="mi">2</span>
      <span class="c1"># file does not exist -&gt; upload</span>
      <span class="n">sftp</span><span class="p">.</span><span class="nf">upload!</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">)</span>
      <span class="n">sftp</span><span class="p">.</span><span class="nf">setstat</span><span class="p">(</span><span class="n">remote_file</span><span class="p">,</span> <span class="ss">permissions: </span><span class="n">client</span><span class="p">.</span><span class="nf">file_perm</span><span class="p">)</span>
      <span class="nb">puts</span> <span class="s2">"creating </span><span class="si">#{</span><span class="n">remote_file</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_directory</span><span class="p">(</span><span class="n">sftp</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">dir_structure</span><span class="p">,</span> <span class="n">remote_dir</span><span class="p">)</span>
    <span class="c1"># do subdirectories need to be created?</span>
    <span class="k">if</span> <span class="n">dir_structure</span><span class="p">.</span><span class="nf">size</span> <span class="o">&lt;=</span> <span class="mi">1</span>
      <span class="c1"># no subdirectories</span>
      <span class="n">sftp</span><span class="p">.</span><span class="nf">mkdir!</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>
      <span class="nb">puts</span> <span class="s2">"creating dir: </span><span class="si">#{</span><span class="n">remote_dir</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">else</span>
      <span class="c1"># iterate over subdirectories and create them</span>
      <span class="n">dir_structure</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">_d</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
        <span class="k">begin</span>
          <span class="c1"># code diamond &lt;3</span>
          <span class="n">subdir</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">remote_path</span> <span class="o">+</span> <span class="s2">"/</span><span class="si">#{</span><span class="n">dir_structure</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">i</span><span class="p">].</span><span class="nf">join</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
          <span class="n">sftp</span><span class="p">.</span><span class="nf">mkdir!</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="ss">permissions: </span><span class="n">client</span><span class="p">.</span><span class="nf">dir_perm</span><span class="p">)</span>
          <span class="nb">puts</span> <span class="s2">"creating dir: </span><span class="si">#{</span><span class="n">subdir</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">rescue</span> <span class="no">Net</span><span class="o">::</span><span class="no">SFTP</span><span class="o">::</span><span class="no">StatusException</span> <span class="o">=&gt;</span> <span class="n">e</span>
          <span class="k">raise</span> <span class="k">unless</span> <span class="n">e</span><span class="p">.</span><span class="nf">code</span> <span class="o">==</span> <span class="mi">4</span>
          <span class="c1"># directory or subdirectory exists</span>
          <span class="k">next</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Upload2SFTP</span><span class="p">.</span><span class="nf">upload</span>
</code></pre></div></div>


<hr />

<a href="/2018/read-yaml-config-files/" style="text-decoration:none;">⬅️ Read previous</a>

<a href="/2018/base64-img-encoding-ruby/" style="float: right; text-decoration:none;">Read next ➡️</a>

    </main>

    <footer>
  <p style="text-align:center"><strong>
    <a href="/feed.xml">Feed</a>
  </strong></p>

  <hr />

  <h6>Imprint</h6>
  <p>
    <strong>Simon Neutert</strong><br />
    <span id="imprint-address">
      Postfach 1120, 55258 Ingelheim
    </span>
  </p>
  <p style="text-align:center"><strong>
    Generated using <a href="https://www.bridgetownrb.com">Bridgetown</a>
  </strong></p>
</footer>

  </body>
</html>
